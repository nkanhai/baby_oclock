<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üçº Baby Tracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1f2e">
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #1a1f2e;
            color: #e8eaed;
            padding: 16px;
            padding-bottom: 32px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .last-feed-container {
            background: #252b3b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .last-feed-time {
            font-size: 32px;
            font-weight: 700;
            color: #4A90D9;
            margin-bottom: 8px;
        }

        .last-feed-details {
            font-size: 16px;
            color: #a8adb8;
            line-height: 1.4;
        }

        .last-feed-none {
            font-size: 18px;
            color: #a8adb8;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 32px;
        }

        .action-btn {
            background: #2d3548;
            border: 2px solid #3d4556;
            border-radius: 16px;
            padding: 24px 16px;
            font-size: 18px;
            font-weight: 600;
            color: #e8eaed;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-height: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        .action-btn:active {
            transform: scale(0.95);
            background: #353b4e;
        }

        .action-btn .emoji {
            font-size: 36px;
            line-height: 1;
        }

        .action-btn.bottle {
            border-color: #4A90D9;
        }

        .action-btn.nurse {
            border-color: #E8877C;
        }

        .action-btn.pump {
            border-color: #5CB8B2;
        }

        .action-btn.voice {
            border-color: #9b87e8;
        }

        .action-btn.diaper {
            border-color: #9C87E8;
        }

        .action-btn.diaper:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(156, 135, 232, 0.3);
        }

        .diaper-side-btn {
            border-color: #9C87E8;
        }

        .diaper-side-btn.selected {
            background: #9C87E8;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #252b3b;
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .quick-amount-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .quick-btn {
            background: #2d3548;
            border: 2px solid #4A90D9;
            border-radius: 12px;
            padding: 16px 12px;
            font-size: 18px;
            font-weight: 600;
            color: #e8eaed;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:active {
            background: #4A90D9;
            transform: scale(0.95);
        }

        .side-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .side-btn {
            background: #2d3548;
            border: 2px solid #E8877C;
            border-radius: 12px;
            padding: 16px 12px;
            font-size: 16px;
            font-weight: 600;
            color: #e8eaed;
            cursor: pointer;
            transition: all 0.2s;
        }

        .side-btn:active,
        .side-btn.selected {
            background: #E8877C;
            transform: scale(0.95);
        }

        .bottle-type-btn {
            border-color: #4A90D9;
        }

        .bottle-type-btn:active,
        .bottle-type-btn.selected {
            background: #4A90D9 !important;
            /* Force override side-btn active */
            color: white;
        }

        .pump-side-btn {
            border-color: #5CB8B2;
        }

        .pump-side-btn:active,
        .pump-side-btn.selected {
            background: #5CB8B2;
            color: white;
        }

        .custom-input-group {
            margin-bottom: 16px;
        }

        .custom-input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #a8adb8;
        }

        .custom-input {
            width: 100%;
            background: #1a1f2e;
            border: 2px solid #3d4556;
            border-radius: 12px;
            padding: 14px;
            font-size: 16px;
            color: #e8eaed;
            font-family: inherit;
        }

        .custom-input:focus {
            outline: none;
            border-color: #4A90D9;
        }

        .expandable {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #3d4556;
        }

        .expandable-toggle {
            background: none;
            border: none;
            color: #4A90D9;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            margin-bottom: 12px;
        }

        .expandable-content {
            display: none;
        }

        .expandable-content.active {
            display: block;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            background: #4A90D9;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .modal-btn.secondary {
            background: #3d4556;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3548;
            color: #e8eaed;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 12px;
            max-width: 90%;
        }

        .toast.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .toast-message {
            flex: 1;
        }

        .toast-undo {
            background: #4A90D9;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        /* Feed log */
        .log-section {
            margin-top: 32px;
        }

        .log-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #3d4556;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-summary {
            font-size: 13px;
            color: #a8adb8;
            font-weight: 400;
        }

        .feed-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .feed-item {
            background: #252b3b;
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feed-info {
            flex: 1;
        }

        .feed-time {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .feed-details {
            font-size: 14px;
            color: #a8adb8;
        }

        .feed-delete {
            background: #aa4444;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .feed-delete:active {
            transform: scale(0.9);
        }

        .empty-state {
            text-align: center;
            color: #a8adb8;
            padding: 40px 20px;
            font-size: 16px;
        }

        /* Who's logging toggle */
        .who-toggle {
            display: flex;
            gap: 8px;
            background: #252b3b;
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 20px;
        }

        .who-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #a8adb8;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .who-btn.active {
            background: #4A90D9;
            color: white;
        }

        /* Voice modal */
        .voice-listening {
            text-align: center;
            padding: 20px;
        }

        .voice-animation {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: #9b87e8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .voice-transcript {
            font-size: 18px;
            margin: 20px 0;
            padding: 16px;
            background: #1a1f2e;
            border-radius: 12px;
            min-height: 60px;
        }

        .voice-parsed {
            background: #2d3548;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: left;
        }

        .voice-parsed-item {
            margin: 8px 0;
            font-size: 14px;
        }

        .voice-parsed-label {
            color: #a8adb8;
            display: inline-block;
            width: 80px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #a8adb8;
        }

        /* Tumbler UI */
        .tumbler-wrapper {
            margin-bottom: 20px;
        }

        .modal-subtitle {
            text-align: center;
            color: #a8adb8;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .tumbler-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            height: 180px;
            /* Show 3 items: top, center (selected), bottom */
            background: #252b3b;
            border-radius: 12px;
            padding: 0;
            position: relative;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
        }

        .tumbler-highlight {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 60px;
            margin-top: -30px;
            background: rgba(74, 144, 217, 0.1);
            border-top: 1px solid #4A90D9;
            border-bottom: 1px solid #4A90D9;
            pointer-events: none;
            z-index: 10;
        }

        .tumbler-column {
            width: 80px;
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            text-align: center;
            -ms-overflow-style: none;
            scrollbar-width: none;
            z-index: 20;
            padding-top: 60px;
            padding-bottom: 60px;
            scroll-behavior: smooth;
        }

        .tumbler-column::-webkit-scrollbar {
            display: none;
        }

        .tumbler-item {
            height: 60px;
            line-height: 60px;
            font-size: 32px;
            font-weight: 700;
            color: #5c6270;
            scroll-snap-align: center;
            transition: all 0.2s;
        }

        .tumbler-item.active {
            color: #fff;
            font-size: 42px;
            transform: scale(1.1);
        }

        .tumbler-unit {
            align-self: center;
            font-size: 28px;
            font-weight: bold;
            color: #a8adb8;
            margin-left: 10px;
            z-index: 20;
        }

        .live-clock {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin-top: 8px;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            color: #e8eaed;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Grouped History */
        details.feed-group {
            margin-bottom: 20px;
        }

        summary.group-header {
            font-size: 20px;
            font-weight: 700;
            color: #4A90D9;
            margin-bottom: 12px;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            user-select: none;
        }

        summary.group-header::-webkit-details-marker {
            display: none;
        }

        summary.group-header::after {
            content: '+';
            font-size: 24px;
            font-weight: 300;
            color: #a8adb8;
            transition: transform 0.2s;
        }

        details.feed-group[open] summary.group-header::after {
            transform: rotate(45deg);
        }

        .feed-delete {
            background: none;
            border: none;
            color: #5c6270;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            /* Increased margin for edit button spacing */
            transition: color 0.2s;
        }

        .feed-delete:hover {
            color: #E8877C;
        }

        .feed-edit {
            background: none;
            border: none;
            color: #5c6270;
            font-size: 16px;
            /* Slightly smaller than delete */
            cursor: pointer;
            padding: 4px;
            margin-left: auto;
            /* Push to right, before delete */
            transition: color 0.2s;
        }

        .feed-edit:hover {
            color: #4A90D9;
            /* Blue for edit */
        }

        details.feed-group.highlight-group summary.group-header::after {
            display: none;
            /* Always open, no toggle needed */
        }

        /* Next Feed Timer */
        .next-feed-timer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #404554;
        }

        .next-feed-label {
            font-size: 14px;
            color: #a8adb8;
            margin-bottom: 4px;
        }

        .next-feed-value {
            font-size: 24px;
            font-weight: 600;
            color: #4A90D9;
        }

        .next-feed-value.overdue {
            color: #E8877C;
        }

        /* Daily Goal Progress */
        .daily-goal-container {
            background: #252b3b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .daily-goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .daily-goal-title {
            font-size: 16px;
            font-weight: 600;
            color: #e8eaed;
        }

        .daily-goal-value {
            font-size: 16px;
            color: #a8adb8;
        }

        .progress-bar-bg {
            background: #1a1f2e;
            height: 16px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 8px;
            /* Smooth gradient from Blue to Purple */
            background: linear-gradient(90deg, #4A90D9 0%, #6c8de3 60%, #9C87E8 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-bar-fill.great {
            box-shadow: 0 0 12px rgba(156, 135, 232, 0.6);
            /* Glow when doing great */
        }

        .daily-goal-status {
            font-size: 13px;
            color: #a8adb8;
            text-align: right;
        }

        /* Vitamin D Reminder */
        .vitamin-reminder {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #2d2a1f 0%, #2d3548 100%);
            border-left: 4px solid #F5A623;
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .vitamin-reminder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(245, 166, 35, 0.06) 0%, transparent 60%);
            pointer-events: none;
        }

        .vitamin-reminder:active {
            transform: scale(0.98);
        }

        .vitamin-icon {
            font-size: 24px;
            flex-shrink: 0;
            z-index: 1;
        }

        .vitamin-text {
            font-size: 15px;
            font-weight: 600;
            color: #e8eaed;
            flex: 1;
            z-index: 1;
        }

        .vitamin-check {
            font-size: 24px;
            font-weight: 700;
            color: #4CD964;
            opacity: 0;
            transform: scale(0);
            transition: none;
            z-index: 1;
        }

        .vitamin-reminder.confirming .vitamin-check {
            animation: vitaminConfirm 0.4s ease forwards;
        }

        .vitamin-reminder.confirming .vitamin-text {
            color: #4CD964;
        }

        .vitamin-reminder.confirming {
            border-left-color: #4CD964;
            background: linear-gradient(135deg, #1f2d1f 0%, #2d3548 100%);
        }

        .vitamin-reminder.sliding-out {
            animation: vitaminSlideOut 0.5s ease forwards;
        }

        @keyframes vitaminConfirm {
            0% {
                opacity: 0;
                transform: scale(0);
            }

            50% {
                opacity: 1;
                transform: scale(1.3);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes vitaminSlideOut {
            0% {
                opacity: 1;
                max-height: 60px;
                margin-bottom: 16px;
                padding: 14px 18px;
            }

            100% {
                opacity: 0;
                max-height: 0;
                margin-bottom: 0;
                padding: 0 18px;
                transform: translateY(-10px);
            }
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            background: #252b3b;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #a8adb8;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-btn.active {
            background: #4A90D9;
            color: white;
        }

        /* Chart View */
        .chart-range-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .range-btn {
            background: #2d3548;
            border: 2px solid #3d4556;
            border-radius: 10px;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #a8adb8;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .range-btn.active {
            background: #4A90D9;
            border-color: #4A90D9;
            color: white;
        }

        .chart-card {
            background: #252b3b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #e8eaed;
        }

        .chart-card canvas {
            width: 100% !important;
            max-height: 260px;
        }

        .chart-empty {
            text-align: center;
            padding: 40px 20px;
            color: #a8adb8;
            font-size: 15px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <h1>üçº Esm√©'s Feed Tracker</h1>
        <div id="liveClock" class="live-clock">--:--</div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="tracker">Tracker</button>
        <button class="tab-btn" data-tab="charts">üìà Charts</button>
    </div>

    <!-- Tracker View -->
    <div id="trackerView">

        <!-- Who's logging toggle -->
        <div class="who-toggle">
            <button class="who-btn active" data-who="Mom">Mom</button>
            <button class="who-btn" data-who="Dad">Dad</button>
        </div>

        <!-- Vitamin D Reminder -->
        <div class="vitamin-reminder" id="vitaminReminder" style="display: none;" onclick="logVitamin()">
            <span class="vitamin-icon">‚òÄÔ∏è</span>
            <span class="vitamin-text">Tap to give Vitamin D drops</span>
            <span class="vitamin-check" id="vitaminCheck">‚úì</span>
        </div>

        <!-- Last feed status -->
        <div class="last-feed-container" id="lastFeedContainer">
            <div class="last-feed-none">Loading...</div>
        </div>

        <!-- Daily Goal Progress -->
        <div class="daily-goal-container" id="dailyGoalContainer" style="display: none;">
            <div class="daily-goal-header">
                <span class="daily-goal-title">Today's Total</span>
                <span class="daily-goal-value" id="dailyGoalValue">-- / 500 ml</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="dailyGoalBar" style="width: 0%"></div>
            </div>
            <div class="daily-goal-status" id="dailyGoalStatus">Loading...</div>
        </div>

        <!-- Action buttons -->
        <div class="action-grid">
            <button class="action-btn bottle" id="bottleBtn">
                <span class="emoji">üçº</span>
                <span>Bottle</span>
            </button>
            <button class="action-btn nurse" id="nurseBtn">
                <span class="emoji">ü§±</span>
                <span>Nurse</span>
            </button>
            <button class="action-btn pump" id="pumpBtn">
                <span class="emoji">üíß</span>
                <span>Pump</span>
            </button>
            <button class="action-btn voice" id="voiceBtn">
                <span class="emoji">üé§</span>
                <span>Voice</span>
            </button>
            <button class="action-btn diaper" id="diaperBtn">
                <span class="emoji">üçë</span>
                <span>Diaper</span>
            </button>
        </div>

        <!-- Today's log -->
        <div class="log-section">
            <div class="log-header" style="display:none"> <!-- Hidden in favor of grouped headers -->
                <span>Today's Log</span>
                <span class="stats-summary" id="statsText">‚Äî</span>
            </div>
            <div class="feed-list" id="feedList">
                <div class="loading">Loading feeds...</div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal" id="bottleModal">
            <div class="modal-content">
                <div class="modal-title">üçº Bottle Feed</div>

                <div class="tumbler-wrapper">
                    <div class="modal-subtitle">Select Amount</div>
                    <!-- Tumbler Logic via JS -->
                    <div class="tumbler-container" id="bottleTumbler">
                        <div class="tumbler-highlight"></div>
                        <div class="tumbler-column" id="bottleTens"></div>
                        <div class="tumbler-column" id="bottleOnes"></div>
                        <div class="tumbler-unit">ml</div>
                    </div>
                </div>

                <!-- Milk vs Formula Selection -->
                <div class="side-selector">
                    <button class="side-btn bottle-type-btn" data-type="milk"
                        onclick="selectBottleType('milk')">Milk</button>
                    <button class="side-btn bottle-type-btn" data-type="formula"
                        onclick="selectBottleType('formula')">Formula</button>
                </div>

                <div class="custom-input-group">
                    <label>Or type custom amount:</label>
                    <input type="number" class="custom-input" id="bottleCustomMl" placeholder="Optional override">
                </div>

                <div class="expandable">
                    <button class="expandable-toggle" id="bottleMoreToggle">+ More options</button>
                    <div class="expandable-content" id="bottleMoreContent">
                        <div class="custom-input-group">
                            <label>Duration (minutes)</label>
                            <input type="number" class="custom-input" id="bottleDuration" placeholder="Optional">
                        </div>
                        <div class="custom-input-group">
                            <label>Notes</label>
                            <input type="text" class="custom-input" id="bottleNotes" placeholder="Optional">
                        </div>
                        <div class="custom-input-group">
                            <label>Time</label>
                            <input type="time" class="custom-input" id="bottleTime">
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn secondary" id="bottleCancel">Cancel</button>
                    <button class="modal-btn" id="bottleSelect">Select</button>
                </div>
            </div>
        </div>

        <div class="modal" id="nurseModal">
            <div class="modal-content">
                <div class="modal-title">ü§± Nursing</div>
                <div class="side-selector">
                    <button class="side-btn" data-side="left">Left</button>
                    <button class="side-btn" data-side="right">Right</button>
                    <button class="side-btn" data-side="both">Both</button>
                </div>
                <div class="expandable">
                    <button class="expandable-toggle" id="nurseMoreToggle">+ More options</button>
                    <div class="expandable-content" id="nurseMoreContent">
                        <div class="custom-input-group">
                            <label>Duration (minutes)</label>
                            <input type="number" class="custom-input" id="nurseDuration" placeholder="Optional">
                        </div>
                        <div class="custom-input-group">
                            <label>Notes</label>
                            <input type="text" class="custom-input" id="nurseNotes" placeholder="Optional">
                        </div>
                        <div class="custom-input-group">
                            <label>Time</label>
                            <input type="time" class="custom-input" id="nurseTime">
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn secondary" id="nurseCancel">Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal" id="pumpModal">
            <div class="modal-content">
                <div class="modal-title">üíß Pump</div>
                <div class="side-selector">
                    <button class="side-btn pump-side-btn" data-side="left">Left</button>
                    <button class="side-btn pump-side-btn" data-side="right">Right</button>
                    <button class="side-btn pump-side-btn" data-side="both">Both</button>
                </div>
                <div id="pumpAmountSection" style="display: none;">
                    <div class="tumbler-wrapper">
                        <div class="modal-subtitle">Select Amount</div>
                        <div class="tumbler-container">
                            <div class="tumbler-highlight"></div>
                            <div class="tumbler-column" id="pumpTens"></div>
                            <div class="tumbler-column" id="pumpOnes"></div>
                            <div class="tumbler-unit">ml</div>
                        </div>
                    </div>

                    <div class="expandable">
                        <button class="expandable-toggle" id="pumpMoreToggle">+ More options</button>
                        <div class="expandable-content" id="pumpMoreContent">
                            <div class="custom-input-group">
                                <label>Custom amount (ml)</label>
                                <input type="number" class="custom-input" id="pumpCustomMl"
                                    placeholder="Optional override">
                            </div>
                            <div class="custom-input-group">
                                <label>Duration (minutes)</label>
                                <input type="number" class="custom-input" id="pumpDuration" placeholder="Optional">
                            </div>
                            <div class="custom-input-group">
                                <label>Notes</label>
                                <input type="text" class="custom-input" id="pumpNotes" placeholder="Optional">
                            </div>
                            <div class="custom-input-group">
                                <label>Time</label>
                                <input type="time" class="custom-input" id="pumpTime">
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn secondary" id="pumpCancel">Cancel</button>
                        <button class="modal-btn" id="pumpSelect">Select</button>
                    </div>
                </div>
                <div id="pumpInitialActions" class="modal-actions">
                    <button class="modal-btn secondary" id="pumpCancelInitial">Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal" id="diaperModal">
            <div class="modal-content">
                <div class="modal-title">üçë Diaper Change</div>

                <div class="side-selector">
                    <button class="side-btn diaper-side-btn" data-type="pee">üíß Pee</button>
                    <button class="side-btn diaper-side-btn" data-type="poop">üí© Poop</button>
                    <button class="side-btn diaper-side-btn" data-type="both">Both</button>
                </div>

                <div class="expandable">
                    <button class="expandable-toggle" id="diaperMoreToggle">+ More options</button>
                    <div class="expandable-content" id="diaperMoreContent">
                        <div class="custom-input-group">
                            <label>Notes</label>
                            <input type="text" class="custom-input" id="diaperNotes"
                                placeholder="Optional notes (e.g., blowout, rash)">
                        </div>
                        <div class="custom-input-group">
                            <label>Time</label>
                            <input type="time" class="custom-input" id="diaperTime">
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="modal-btn secondary" id="diaperCancel">Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal" id="voiceModal">
            <div class="modal-content">
                <div class="modal-title">üé§ Voice Input</div>
                <div class="voice-listening" id="voiceListening">
                    <div class="voice-animation">üé§</div>
                    <p>Listening...</p>
                    <p style="font-size: 14px; color: #a8adb8; margin-top: 8px;">
                        Say something like:<br>
                        "Bottle 80 ml"<br>
                        "Nurse left 10 minutes"
                    </p>
                </div>
                <div class="voice-transcript" id="voiceTranscript"></div>
                <div id="voiceParsedSection" style="display: none;">
                    <div class="voice-parsed" id="voiceParsed"></div>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn secondary" id="voiceCancel">Cancel</button>
                    <button class="modal-btn" id="voiceConfirm" style="display: none;">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast" id="toast">
            <span class="toast-message" id="toastMessage"></span>
            <button class="toast-undo" id="toastUndo" style="display: none;">Undo</button>
        </div>

    </div><!-- /trackerView -->

    <!-- Charts View -->
    <div id="chartsView" style="display: none;">
        <div class="chart-range-selector">
            <button class="range-btn active" data-range="7">7d</button>
            <button class="range-btn" data-range="14">14d</button>
            <button class="range-btn" data-range="30">30d</button>
        </div>
        <div class="chart-card">
            <h3>üìä Daily Milk Intake</h3>
            <canvas id="milkChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>üçë Diaper Changes</h3>
            <canvas id="diaperChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>üïê Feed Timeline</h3>
            <canvas id="timelineChart"></canvas>
        </div>
    </div>

    <script>
        // Feature Flags
        const FEATURE_FLAGS = {
            VOICE_INPUT_ENABLED: false  // Set to true to enable voice functionality
        };

        // State
        let currentWho = localStorage.getItem('currentWho') || 'Mom'; // Persist selection
        let lastCreatedFeedId = null;
        let editingFeedId = null;
        let pumpSelectedSide = null;
        let bottleSelectedSide = null; // New for bottle type
        let voiceParsedData = null;
        let editingFeedDate = null; // Store the original date when editing

        // Speech recognition
        let recognition = null;
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
        }

        // Elements
        const bottleBtn = document.getElementById('bottleBtn');
        const nurseBtn = document.getElementById('nurseBtn');
        const pumpBtn = document.getElementById('pumpBtn');
        const voiceBtn = document.getElementById('voiceBtn');

        const bottleModal = document.getElementById('bottleModal');
        const nurseModal = document.getElementById('nurseModal');
        const pumpModal = document.getElementById('pumpModal');
        const diaperModal = document.getElementById('diaperModal');
        const voiceModal = document.getElementById('voiceModal');

        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastUndo = document.getElementById('toastUndo');

        // Hide voice button if not supported or disabled
        if (!FEATURE_FLAGS.VOICE_INPUT_ENABLED || !recognition) {
            voiceBtn.style.display = 'none';
        }

        // Who toggle
        document.querySelectorAll('.who-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.who-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentWho = btn.dataset.who;
                localStorage.setItem('currentWho', currentWho); // Save to localStorage
            });
        });

        // Initialize who toggle state from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const storedWho = localStorage.getItem('currentWho');
            if (storedWho) {
                document.querySelectorAll('.who-btn').forEach(btn => {
                    if (btn.dataset.who === storedWho) {
                        btn.classList.add('active');
                        currentWho = storedWho;
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
        });

        // Expandable toggles
        document.getElementById('bottleMoreToggle').addEventListener('click', function () {
            const content = document.getElementById('bottleMoreContent');
            content.classList.toggle('active');
            this.textContent = content.classList.contains('active') ? '‚àí Less options' : '+ More options';
        });

        document.getElementById('nurseMoreToggle').addEventListener('click', function () {
            const content = document.getElementById('nurseMoreContent');
            content.classList.toggle('active');
            this.textContent = content.classList.contains('active') ? '‚àí Less options' : '+ More options';
        });

        document.getElementById('pumpMoreToggle').addEventListener('click', function () {
            const content = document.getElementById('pumpMoreContent');
            content.classList.toggle('active');
            this.textContent = content.classList.contains('active') ? '‚àí Less options' : '+ More options';
        });

        document.getElementById('diaperMoreToggle').addEventListener('click', function () {
            const content = document.getElementById('diaperMoreContent');
            content.classList.toggle('active');
            this.textContent = content.classList.contains('active') ? '‚àí Less options' : '+ More options';
        });

        // Modal open/close
        bottleBtn.addEventListener('click', () => {
            editingFeedId = null;
            editingFeedDate = null;
            openModal(bottleModal);
        });
        nurseBtn.addEventListener('click', () => {
            editingFeedId = null;
            editingFeedDate = null;
            openModal(nurseModal);
        });
        pumpBtn.addEventListener('click', () => {
            editingFeedId = null;
            editingFeedDate = null;
            openModal(pumpModal);
        });
        document.getElementById('diaperBtn').addEventListener('click', () => {
            editingFeedId = null;
            editingFeedDate = null;
            openModal(diaperModal);
        });
        voiceBtn.addEventListener('click', () => {
            if (FEATURE_FLAGS.VOICE_INPUT_ENABLED && recognition) {
                openModal(voiceModal);
                startVoiceRecognition();
            }
        });

        document.getElementById('bottleCancel').addEventListener('click', () => closeModal(bottleModal));
        document.getElementById('nurseCancel').addEventListener('click', () => closeModal(nurseModal));
        document.getElementById('pumpCancel').addEventListener('click', () => closeModal(pumpModal));
        document.getElementById('diaperCancel').addEventListener('click', () => closeModal(diaperModal));
        document.getElementById('voiceCancel').addEventListener('click', () => {
            if (recognition) recognition.stop();
            closeModal(voiceModal);
        });

        function openModal(modal, isEdit = false) {
            modal.classList.add('active');
            // Reset logic moved to button handlers


            // Reset specific modal states
            if (modal === bottleModal) {
                initTumblers();
                // Reset bottle side selection
                bottleSelectedSide = null;
                document.querySelectorAll('.bottle-type-btn').forEach(btn => btn.classList.remove('selected'));
                validateBottleForm(); // Check validation

                // Clear fields
                document.getElementById('bottleCustomMl').value = '';
                document.getElementById('bottleDuration').value = '';
                document.getElementById('bottleNotes').value = '';
                document.getElementById('bottleSelect').textContent = 'Log Feed';

                // Set time to now
                const now = new Date();
                document.getElementById('bottleTime').value =
                    now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0');
            } else if (modal === nurseModal) {
                document.getElementById('nurseDuration').value = '';
                document.getElementById('nurseNotes').value = '';
                const now = new Date();
                document.getElementById('nurseTime').value =
                    now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0');
                document.querySelectorAll('#nurseModal .side-btn').forEach(b => b.classList.remove('selected'));
            } else if (modal === pumpModal) {
                pumpSelectedSide = null;
                document.getElementById('pumpAmountSection').style.display = 'none';
                document.getElementById('pumpInitialActions').style.display = 'flex';
                document.getElementById('pumpCustomMl').value = '';
                document.getElementById('pumpDuration').value = '';
                document.getElementById('pumpNotes').value = '';
                const now = new Date();
                document.getElementById('pumpTime').value =
                    now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0');
                document.querySelectorAll('#pumpModal .side-btn').forEach(b => b.classList.remove('selected'));
            } else if (modal === voiceModal) {
                document.getElementById('voiceTranscript').textContent = '';
                document.getElementById('voiceParsedSection').style.display = 'none';
                document.getElementById('voiceConfirm').style.display = 'none';
                document.getElementById('voiceListening').style.display = 'block';
            } else if (modal === diaperModal) {
                document.getElementById('diaperNotes').value = '';
                const now = new Date();
                document.getElementById('diaperTime').value =
                    now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0');
                document.querySelectorAll('#diaperModal .side-btn').forEach(b => b.classList.remove('selected'));
            }
        }

        function closeModal(modal) {
            modal.classList.remove('active');

            // Reset edit state whenever a modal is closed
            editingFeedId = null;
            editingFeedDate = null;

            // Reset button text
            const bottleBtn = document.getElementById('bottleSelect');
            if (bottleBtn) bottleBtn.textContent = 'Select';

            const pumpBtn = document.getElementById('pumpSelect');
            if (pumpBtn) pumpBtn.textContent = 'Select';

            // Hide/Reset Save buttons for Nurse/Diaper
            const nurseSave = document.getElementById('nurseSave');
            if (nurseSave) nurseSave.style.display = 'none';

            const diaperSave = document.getElementById('diaperSave');
            if (diaperSave) diaperSave.style.display = 'none';
        }

        document.getElementById('bottleSelect').addEventListener('click', () => {
            const customMl = parseFloat(document.getElementById('bottleCustomMl').value);
            const ml = customMl || getTumblerValue('bottle');
            logFeed('bottle', bottleSelectedSide, ml);
        });

        // Nurse side buttons
        document.querySelectorAll('#nurseModal .side-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const side = btn.dataset.side;
                // Only log immediately if not editing, otherwise wait for Save
                if (editingFeedId === null) {
                    logFeed('nurse', side);
                } else {
                    // Just visually select it
                    document.querySelectorAll('#nurseModal .side-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                }
            });
        });

        // Pump side buttons
        document.querySelectorAll('#pumpModal .side-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                pumpSelectedSide = btn.dataset.side;
                document.getElementById('pumpAmountSection').style.display = 'block';
                document.getElementById('pumpInitialActions').style.display = 'none';

                // Initialize tumbler if not already
                initTumblers();
            });
        });

        document.getElementById('pumpSelect').addEventListener('click', () => {
            if (pumpSelectedSide) {
                const customMl = parseFloat(document.getElementById('pumpCustomMl').value);
                const ml = customMl || getTumblerValue('pump');
                logFeed('pump', pumpSelectedSide, ml);
            }
        });

        document.getElementById('pumpCancelInitial').addEventListener('click', () => closeModal(pumpModal));

        // Diaper action buttons
        document.querySelectorAll('#diaperModal .side-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.type;
                if (editingFeedId === null) {
                    logFeed('diaper', type);
                } else {
                    document.querySelectorAll('#diaperModal .side-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                }
            });
        });

        // Tumbler Logic
        function initTumblers() {
            // Check if already initialized to avoid duplicate listeners
            if (document.getElementById('bottleTens').children.length === 0) {
                createTumbler('bottleTens', 'bottleCustomMl');
                createTumbler('bottleOnes', 'bottleCustomMl');
                createTumbler('pumpTens', 'pumpCustomMl');
                createTumbler('pumpOnes', 'pumpCustomMl');
            }
        }

        function createTumbler(elementId, clearInputId = null) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; // Clear existing

            for (let i = 0; i <= 9; i++) {
                const item = document.createElement('div');
                item.className = 'tumbler-item';
                item.textContent = i;
                container.appendChild(item);
            }

            // Resolve input element once if ID provided
            const inputToClear = clearInputId ? document.getElementById(clearInputId) : null;
            const clearInput = () => {
                if (inputToClear && inputToClear.value !== '') {
                    inputToClear.value = '';
                }
            };

            // Scroll listener purely for haptic feedback potential or active class updates (optional)
            // For now, relies on CSS scroll-snap
            container.addEventListener('scroll', () => {
                const scrollTop = container.scrollTop;
                const index = Math.round(scrollTop / 60);

                // Update active state
                const items = container.querySelectorAll('.tumbler-item');
                items.forEach((item, i) => {
                    if (i === index) item.classList.add('active');
                    else item.classList.remove('active');
                });

                // Clear input on scroll
                clearInput();
            });

            // Also clear on direct interaction
            container.addEventListener('click', clearInput);
            container.addEventListener('touchstart', clearInput, { passive: true });

            // Trigger initial active state
            const items = container.querySelectorAll('.tumbler-item');
            if (items.length > 0) items[0].classList.add('active');
        }

        function getTumblerValue(prefix) {
            const tensEl = document.getElementById(prefix + 'Tens');
            const onesEl = document.getElementById(prefix + 'Ones');

            const tens = Math.round(tensEl.scrollTop / 60);
            const ones = Math.round(onesEl.scrollTop / 60);

            // Bounds check
            return (Math.min(9, Math.max(0, tens)) * 10) + Math.min(9, Math.max(0, ones));
        }

        // Helper to get HH:MM AM/PM from Date object
        function formatTime(date) {
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            return `${hours}:${minutes} ${ampm}`;
        }

        // Helper to get time string from ISO string
        function getTimeFromIso(isoString) {
            const date = new Date(isoString);
            return date.getHours().toString().padStart(2, '0') + ':' +
                date.getMinutes().toString().padStart(2, '0');
        }

        // Helper to construct ISO string from date and time input
        function constructTimestamp(dateStr, timeInputStr) {
            if (!timeInputStr) return new Date().toISOString();

            // dateStr should be YYYY-MM-DD
            // timeInputStr should be HH:MM

            const [hours, minutes] = timeInputStr.split(':').map(Number);

            let date;
            if (dateStr) {
                // Parse date parts to avoid timezone issues
                const [year, month, day] = dateStr.split('-').map(Number);
                date = new Date(year, month - 1, day);
            } else {
                date = new Date();
            }

            date.setHours(hours);
            date.setMinutes(minutes);
            date.setSeconds(0);
            date.setMilliseconds(0);

            return date.toISOString();
        }

        // Log feed
        async function logFeed(type, side = null, amountMl = null) {
            let duration = null;
            let notes = '';
            let timeStr = '';

            // Get optional fields based on type
            if (type === 'bottle') {
                if (!amountMl) {
                    amountMl = parseFloat(document.getElementById('bottleCustomMl').value) || null;
                }
                duration = parseInt(document.getElementById('bottleDuration').value) || null;
                notes = document.getElementById('bottleNotes').value || '';
                timeStr = document.getElementById('bottleTime').value;
            } else if (type === 'nurse') {
                duration = parseInt(document.getElementById('nurseDuration').value) || null;
                notes = document.getElementById('nurseNotes').value || '';
                timeStr = document.getElementById('nurseTime').value;
            } else if (type === 'pump') {
                if (!amountMl) {
                    amountMl = parseFloat(document.getElementById('pumpCustomMl').value) || null;
                }
                duration = parseInt(document.getElementById('pumpDuration').value) || null;
                notes = document.getElementById('pumpNotes').value || '';
                timeStr = document.getElementById('pumpTime').value;
            } else if (type === 'diaper') {
                notes = document.getElementById('diaperNotes').value || '';
                timeStr = document.getElementById('diaperTime').value;
            }

            // Construct timestamp
            // If editing, use the original date + new time
            // If new, use current date + new time
            const dateBase = editingFeedId !== null ? editingFeedDate : new Date().toLocaleDateString('en-CA');
            const timestamp = constructTimestamp(dateBase, timeStr);

            const feedData = {
                type: type,
                side: side,
                amount_ml: amountMl,
                duration_min: duration,
                notes: notes,
                logged_by: currentWho,
                timestamp: timestamp
            };

            try {
                let url = '/api/feeds';
                let method = 'POST';
                if (editingFeedId !== null) {
                    url = `/api/feeds/${editingFeedId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedData)
                });

                const result = await response.json();

                if (result.success) {
                    if (method === 'POST') lastCreatedFeedId = result.id;

                    // Close modal
                    closeModal(bottleModal);
                    closeModal(nurseModal);
                    closeModal(pumpModal);
                    closeModal(diaperModal);
                    closeModal(voiceModal);

                    // Show toast
                    // Only show undo for NEW feeds (POST), not edits (PUT)
                    showToast(buildFeedSummary(type, side, amountMl, duration), method === 'POST');

                    // Refresh feeds
                    loadFeeds();
                }
            } catch (error) {
                console.error('Error logging feed:', error);
                showToast('Error logging feed', false);
            }
        }

        function buildFeedSummary(type, side, amountMl, duration) {
            let summary = '';
            if (type === 'bottle') {
                summary = 'üçº Bottle';
                if (side === 'formula') summary += ' (Formula)';
                else if (side === 'milk') summary += ' (Milk)';
            } else if (type === 'nurse') {
                summary = 'ü§± Nurse';
                if (side) summary += ` (${side})`;
            } else if (type === 'pump') {
                summary = 'üíß Pump';
                if (side) summary += ` (${side})`;
            } else if (type === 'diaper') {
                summary = 'üçë Diaper';
                if (side) summary += ` (${side})`;
            }

            if (amountMl) summary += ` ‚Äî ${amountMl} ml`;
            if (duration) summary += ` ‚Äî ${duration} min`;

            return summary + ' logged';
        }

        // New functions for bottle selection
        function selectBottleType(type) {
            bottleSelectedSide = type;
            document.querySelectorAll('.bottle-type-btn').forEach(btn => {
                if (btn.dataset.type === type) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
            validateBottleForm();
        }

        function validateBottleForm() {
            const selectBtn = document.getElementById('bottleSelect');
            if (bottleSelectedSide) {
                selectBtn.disabled = false;
                selectBtn.style.opacity = '1';
                selectBtn.textContent = editingFeedId ? 'Save Changes' : 'Log Feed';
            } else {
                selectBtn.disabled = true;
                selectBtn.style.opacity = '0.5';
                selectBtn.textContent = 'Select Milk or Formula';
            }
        }

        // Toast
        let toastTimeout = null;
        function showToast(message, showUndo = false) {
            clearTimeout(toastTimeout);

            toastMessage.textContent = message;
            toastUndo.style.display = showUndo ? 'block' : 'none';
            toast.classList.add('active');

            toastTimeout = setTimeout(() => {
                toast.classList.remove('active');
                lastCreatedFeedId = null;
            }, 5000);
        }

        // Undo
        toastUndo.addEventListener('click', async () => {
            if (lastCreatedFeedId !== null) {
                try {
                    const response = await fetch(`/api/feeds/${lastCreatedFeedId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        toast.classList.remove('active');
                        lastCreatedFeedId = null;
                        loadFeeds();
                    }
                } catch (error) {
                    console.error('Error undoing feed:', error);
                }
            }
        });

        // Load feeds
        async function loadFeeds() {
            try {
                // Fetch 7 days of history as per requirements
                const response = await fetch('/api/feeds?limit_days=7');
                const data = await response.json();
                currentFeeds = data.feeds; // Store feeds globally

                // Update last feed
                const lastFeedContainer = document.getElementById('lastFeedContainer');
                if (data.last_feed_minutes_ago !== null) {
                    const timeAgo = formatTimeAgo(data.last_feed_minutes_ago);
                    lastFeedContainer.innerHTML = `
                        <div class="last-feed-time">${timeAgo}</div>
                        <div class="last-feed-details">${data.last_feed_summary}</div>
                    `;
                } else {
                    lastFeedContainer.innerHTML = '<div class="last-feed-none">No feeds logged today</div>';
                }

                // Display last diaper change timer
                if (data.last_diaper_minutes_ago !== null) {
                    const hours = Math.floor(data.last_diaper_minutes_ago / 60);
                    const mins = data.last_diaper_minutes_ago % 60;
                    let timeStr = hours > 0 ? `${hours}h ${mins}m ago` : `${mins}m ago`;

                    lastFeedContainer.innerHTML += `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #404554;">
                            <div style="font-size: 14px; color: #a8adb8;">Last diaper change</div>
                            <div style="font-size: 24px; font-weight: 600; color: #9C87E8; margin-top: 4px;">
                                ${timeStr}
                            </div>
                            <div style="font-size: 13px; color: #8a8f9e; margin-top: 2px;">
                                ${data.last_diaper_summary}
                            </div>
                        </div>
                    `;
                }

                // --- Next Feed Timer Logic ---
                // Find most recent FEED (not diaper, not vitamin, NOT Pump) to calc next feed time
                let lastFeedObj = null;
                for (const feed of data.feeds) {
                    const type = feed.type.toLowerCase();
                    // Must be Bottle or Nurse (exclude Pump, Diaper, Vitamin)
                    if (type.includes('bottle') || type.includes('nurse')) {
                        lastFeedObj = feed;
                        break;
                    }
                }

                if (lastFeedObj) {
                    const lastFeedTime = new Date(lastFeedObj.timestamp);
                    const nextFeedTime = new Date(lastFeedTime.getTime() + 3 * 60 * 60 * 1000); // +3 hours
                    const now = new Date();
                    const diffMs = nextFeedTime - now;
                    const diffMins = Math.floor(diffMs / 60000);

                    let label = "Next feed in";
                    let valueClass = "next-feed-value";
                    let timeText = "";

                    if (diffMins < 0) {
                        label = "Next feed overdue by";
                        valueClass += " overdue";
                        timeText = formatTimeAgo(Math.abs(diffMins));
                    } else {
                        const h = Math.floor(diffMins / 60);
                        const m = diffMins % 60;
                        if (h > 0) timeText = `${h}h ${m}m`;
                        else timeText = `${m}m`;
                    }

                    // Append to container
                    lastFeedContainer.innerHTML += `
                        <div class="next-feed-timer">
                            <div class="next-feed-label">${label}</div>
                            <div class="${valueClass}">${timeText}</div>
                            <div style="font-size: 13px; color: #8a8f9e; margin-top: 2px;">
                                Target: ${formatTime(nextFeedTime)}
                            </div>
                        </div>
                    `;
                }


                // --- Daily Goal Logic ---
                // Filter feeds for TODAY (Local client time)
                const nowLocal = new Date();
                const year = nowLocal.getFullYear();
                const month = String(nowLocal.getMonth() + 1).padStart(2, '0');
                const day = String(nowLocal.getDate()).padStart(2, '0');
                const todayKey = `${year}-${month}-${day}`;

                // Calculate today's total ml
                let todayMl = 0;
                // create map if not exists
                const groupsForGoal = groupFeedsByDate(data.feeds);
                const todayFeeds = groupsForGoal[todayKey] || [];
                todayFeeds.forEach(f => {
                    // Only count Bottle feeds (Milk/Formula)
                    // Exclude Pump, Nurse, Vitamin D
                    if (f.amount_ml && f.type.includes('Bottle') && !f.type.includes('Vitamin D')) {
                        todayMl += f.amount_ml;
                    }
                });

                // Update UI
                const goalContainer = document.getElementById('dailyGoalContainer');
                const goalValue = document.getElementById('dailyGoalValue');
                const goalBar = document.getElementById('dailyGoalBar');
                const goalStatus = document.getElementById('dailyGoalStatus');

                goalContainer.style.display = 'block';
                goalValue.textContent = `${Math.round(todayMl)} / 500 ml`;

                // Calculate percentage (max 100 for width)
                const percentage = Math.min(100, Math.max(5, (todayMl / 500) * 100)); // Min 5% so bar is visible
                goalBar.style.width = `${percentage}%`;

                // Classes
                // Classes
                goalBar.className = 'progress-bar-fill'; // Reset
                let statusText = "";

                if (todayMl >= 500) {
                    goalBar.classList.add('great');
                    statusText = "üéâ Goal Met!";
                } else if (todayMl >= 450) {
                    goalBar.classList.add('great'); // Purple glow range
                    statusText = "üíú Almost there!";
                } else if (todayMl >= 400) {
                    statusText = "‚úÖ Minimum met";
                } else if (todayMl >= 200) {
                    statusText = "On track";
                } else {
                    statusText = "Keep going";
                }
                goalStatus.textContent = statusText;

                // Update stats
                const statsText = document.getElementById('statsText');
                statsText.textContent = `${data.total_feeds_today} feeds ‚Ä¢ ${data.total_ml_today} ml`;

                // Update feed list
                // Update stats (global or just today?)
                // API returns stats for "today" in top level fields still?
                // Actually `total_feeds_today` comes from `get_feeds`.
                // If we request limit_days, the backend calculates stats based on returned feeds?
                // Wait, backend `get_feeds`:
                // total_ml_today calculated from `feeds`. If `feeds` has 7 days, it sums 7 days?
                // Let's verify backend logic.
                // Backend: "for feed in feeds: total_ml_today += feed['amount_ml']"
                // YES! Backend sums everything in the response!
                // We likely want to calculate "Today's" stats in JS now if the API returns 7 days.
                // Or we accept that "Today's Log" stats at the top might be misleading if we don't filter.
                // Let's filter on frontend for the top stats.

                // Filter feeds for today for stats
                const todayStr = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD in local time (approx)
                // Actually backend returns YYYY-MM-DD.
                // Let's use the first group if it matches today.

                // Group feeds
                const groups = groupFeedsByDate(data.feeds);
                const sortedDates = Object.keys(groups).sort().reverse();

                // Render
                const feedList = document.getElementById('feedList');

                if (data.feeds.length === 0) {
                    feedList.innerHTML = '<div class="empty-state">No feeds logged in the last 7 days.<br>Tap a button above to start tracking!</div>';
                } else {
                    let html = '';
                    sortedDates.forEach(date => {
                        const dayFeeds = groups[date];
                        const isToday = isDateToday(date);
                        const isYesterday = isDateYesterday(date);

                        let label = formatDateLabel(date);
                        let openAttr = (isToday || isYesterday) ? 'open' : '';
                        let checkClass = (isToday || isYesterday) ? 'highlight-group' : '';

                        // Recalculate stats for this group
                        let groupMl = 0;
                        let groupCount = dayFeeds.length;
                        dayFeeds.forEach(f => { if (f.amount_ml) groupMl += f.amount_ml; });
                        const groupStats = `${groupCount} feeds ‚Ä¢ ${Math.round(groupMl)} ml`;

                        html += `
                            <details class="feed-group ${checkClass}" ${openAttr}>
                                <summary class="group-header">
                                    <span>${label}</span>
                                    <span style="font-size: 14px; color: #a8adb8; font-weight: normal; margin-right: 10px;">${groupStats}</span>
                                </summary>
                                <div class="group-content">
                                    ${dayFeeds.map(feed => renderFeedItem(feed)).join('')}
                                </div>
                            </details>
                        `;
                    });
                    feedList.innerHTML = html;

                    // Update main stats text to show TODAY's stats specifically
                    // We can match "todayStr" from backend format.
                    // Actually, let's grab the group for today.
                    // The backend `total_ml_today` is now "Total ML in response".
                    // We should recalculate Today's stats here or update backend to separate them.
                    // Easiest is JS recalc.
                    // We effectively did it above for the group header.
                    // Let's update the global stats text if "Today" exists.
                    // Get today's date string from backend response? No, construct it.
                    // Backend returns `feed.date` as "YYYY-MM-DD".
                    // We need to match that.
                    // Just find the group that isToday.

                    // Find today group
                    // Helper to get YYYY-MM-DD local
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const todayKey = `${year}-${month}-${day}`;

                    const todayGroup = groups[todayKey] || [];
                    let todayMl = 0;
                    todayGroup.forEach(f => {
                        if (f.amount_ml && !f.type.toLowerCase().includes('pump') && !f.type.includes('Vitamin D')) {
                            todayMl += f.amount_ml;
                        }
                    });

                    // const statsText = document.getElementById('statsText');
                    statsText.textContent = `${todayGroup.length} feeds ‚Ä¢ ${Math.round(todayMl)} ml (Today)`;
                }

                // Refresh vitamin status after loading feeds
                checkVitaminStatus();
            } catch (error) {
                console.error('Error loading feeds:', error);
            }
        }

        function groupFeedsByDate(feeds) {
            const groups = {};
            feeds.forEach(feed => {
                if (!groups[feed.date]) groups[feed.date] = [];
                groups[feed.date].push(feed);
            });
            return groups;
        }

        function isDateToday(dateStr) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return dateStr === `${year}-${month}-${day}`;
        }

        function isDateYesterday(dateStr) {
            const yester = new Date();
            yester.setDate(yester.getDate() - 1);
            const year = yester.getFullYear();
            const month = String(yester.getMonth() + 1).padStart(2, '0');
            const day = String(yester.getDate()).padStart(2, '0');
            return dateStr === `${year}-${month}-${day}`;
        }

        function formatDateLabel(dateStr) {
            if (isDateToday(dateStr)) return 'Today';
            if (isDateYesterday(dateStr)) return 'Yesterday';

            // Format as "Monday, 02/10"
            const parts = dateStr.split('-');
            // parts[0] is year, parts[1] is month, parts[2] is day
            // Construct date object safely (avoid timezone shifts)
            const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            const options = { weekday: 'long', month: 'numeric', day: 'numeric' };
            return dateObj.toLocaleDateString('en-US', options);
        }

        function renderFeedItem(feed) {
            const isVitamin = feed.type.includes('Vitamin D');
            const editBtn = isVitamin ? '' : `<button class="feed-edit" onclick="editFeed(${feed.id})">‚úé</button>`;

            return `
                <div class="feed-item">
                    <div class="feed-info">
                        <div class="feed-time">${feed.time}</div>
                        <div class="feed-details">${buildFeedDetailsText(feed)}</div>
                    </div>
                    ${editBtn}
                    <button class="feed-delete" onclick="deleteFeed(${feed.id})">√ó</button>
                </div>
            `;
        }


        function buildFeedDetailsText(feed) {
            // Special display for Vitamin D entries
            if (feed.type.includes('Vitamin D')) {
                const administered = feed.notes === 'No' ? ' ‚Äî Missed' : '';
                const who = feed.notes === 'No' ? 'Auto-logged' : (feed.logged_by || '');
                return `‚òÄÔ∏è Vitamin D${administered}${who ? ' ‚Ä¢ ' + who : ''}`;
            }

            let details = feed.type
                .replace('Feed (Bottle - Formula)', 'üçº Bottle (Formula)')
                .replace('Feed (Bottle - Milk)', 'üçº Bottle (Milk)')
                .replace('Feed (Bottle)', 'üçº Bottle'); // Old data fall back

            if (feed.amount_ml) details += ` ‚Ä¢ ${feed.amount_ml} ml`;
            if (feed.duration_min) details += ` ‚Ä¢ ${feed.duration_min} min`;
            if (feed.logged_by) details += ` ‚Ä¢ ${feed.logged_by}`;
            return details;
        }

        function editFeed(feedId) {
            // Find feed in current data
            const feed = currentFeeds.find(f => f.id === feedId);
            if (!feed) return;

            editingFeedId = feedId;
            const originalType = feed.type.toLowerCase();

            // Store original date for timestamp reconstruction
            if (feed.timestamp) {
                // feed.timestamp is ISO string
                // Extract YYYY-MM-DD
                editingFeedDate = feed.timestamp.split('T')[0];
            } else {
                // Fallback to today if missing (shouldn't happen)
                editingFeedDate = new Date().toLocaleDateString('en-CA');
            }

            // Get time string HH:MM
            const timeStr = feed.timestamp ? getTimeFromIso(feed.timestamp) : '';

            // Determine type and side/state
            let type = originalType;
            let side = null;

            if (originalType.includes('bottle')) {
                type = 'bottle';
            } else if (originalType.includes('nurse')) {
                type = 'nurse';
                if (originalType.includes('left')) side = 'left';
                else if (originalType.includes('right')) side = 'right';
                else if (originalType.includes('both')) side = 'both';
            } else if (originalType.includes('pump')) {
                type = 'pump';
                if (originalType.includes('left')) side = 'left';
                else if (originalType.includes('right')) side = 'right';
                else if (originalType.includes('both')) side = 'both';
            } else if (originalType.includes('diaper')) {
                type = 'diaper';
                if (originalType.includes('pee')) side = 'pee';
                else if (originalType.includes('poop')) side = 'poop';
                else if (originalType.includes('both')) side = 'both';
            }

            // Open modal and pre-fill
            if (type === 'bottle') {
                openModal(bottleModal, true);
                // Set amount
                if (feed.amount_ml) {
                    setTimeout(() => setTumblerValue('bottle', feed.amount_ml), 10);
                    document.getElementById('bottleCustomMl').value = feed.amount_ml;
                }
                // Set other fields
                if (feed.duration_min) document.getElementById('bottleDuration').value = feed.duration_min;
                if (feed.notes) document.getElementById('bottleNotes').value = feed.notes;
                if (timeStr) document.getElementById('bottleTime').value = timeStr;

                // Set type (Backward compatibility: if plain 'Feed (Bottle)', force selection)
                if (originalType.includes('formula')) {
                    selectBottleType('formula');
                } else if (originalType.includes('milk')) {
                    selectBottleType('milk');
                } else {
                    // Pre-select nothing, force user to choose to save
                    validateBottleForm(); // Will disable button
                }

                // Change button to "Save Changes"
                // handled in validateBottleForm()
            } else if (type === 'nurse') {
                openModal(nurseModal, true);
                // Set side selection
                document.querySelectorAll('#nurseModal .side-btn').forEach(btn => {
                    if (btn.dataset.side === side) btn.classList.add('selected');
                    else btn.classList.remove('selected');
                });
                // Set other fields
                if (feed.duration_min) document.getElementById('nurseDuration').value = feed.duration_min;
                if (feed.notes) document.getElementById('nurseNotes').value = feed.notes;
                if (timeStr) document.getElementById('nurseTime').value = timeStr;

                // Add Save button if not exists (Nurse modal is usually instant)
                let saveBtn = document.getElementById('nurseSave');
                if (!saveBtn) {
                    saveBtn = document.createElement('button');
                    saveBtn.id = 'nurseSave';
                    saveBtn.className = 'modal-btn';
                    saveBtn.textContent = 'Save Changes';
                    saveBtn.onclick = () => {
                        const selectedSide = document.querySelector('#nurseModal .side-btn.selected');
                        if (selectedSide) logFeed('nurse', selectedSide.dataset.side);
                    };
                    document.querySelector('#nurseModal .modal-actions').appendChild(saveBtn);
                }
                saveBtn.style.display = 'block';

            } else if (type === 'pump') {
                openModal(pumpModal, true);
                // Set side
                pumpSelectedSide = side;
                document.querySelectorAll('#pumpModal .side-btn').forEach(btn => {
                    if (btn.dataset.side === side) btn.classList.add('selected');
                    else btn.classList.remove('selected');
                });

                // Show amount section immediately
                document.getElementById('pumpInitialActions').style.display = 'none';
                document.getElementById('pumpAmountSection').style.display = 'block';
                initTumblers(); // Ensure tumblers exist

                // Set amount
                if (feed.amount_ml) {
                    // Need a small timeout for tumblers to render if they were just created
                    setTimeout(() => setTumblerValue('pump', feed.amount_ml), 10);
                    document.getElementById('pumpCustomMl').value = feed.amount_ml;
                }

                if (feed.duration_min) document.getElementById('pumpDuration').value = feed.duration_min;
                if (feed.notes) document.getElementById('pumpNotes').value = feed.notes;
                if (timeStr) document.getElementById('pumpTime').value = timeStr;

                const selectBtn = document.getElementById('pumpSelect');
                selectBtn.textContent = 'Save Changes';

            } else if (type === 'diaper') {
                openModal(diaperModal, true);
                // Set type selection
                document.querySelectorAll('#diaperModal .side-btn').forEach(btn => {
                    if (btn.dataset.type === side) btn.classList.add('selected');
                    else btn.classList.remove('selected');
                });

                if (feed.notes) document.getElementById('diaperNotes').value = feed.notes;
                if (timeStr) document.getElementById('diaperTime').value = timeStr;

                // Add Save button
                let saveBtn = document.getElementById('diaperSave');
                if (!saveBtn) {
                    saveBtn = document.createElement('button');
                    saveBtn.id = 'diaperSave';
                    saveBtn.className = 'modal-btn';
                    saveBtn.textContent = 'Save Changes';
                    saveBtn.onclick = () => {
                        const selectedType = document.querySelector('#diaperModal .side-btn.selected');
                        if (selectedType) logFeed('diaper', selectedType.dataset.type);
                    };
                    document.querySelector('#diaperModal .modal-actions').appendChild(saveBtn);
                }
                saveBtn.style.display = 'block';
            }
        }

        function formatTimeAgo(minutes) {
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${Math.floor(minutes)} min ago`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 1) return mins > 0 ? `${hours} hr ${Math.floor(mins)} min ago` : `${hours} hr ago`;
            return mins > 0 ? `${hours} hrs ${Math.floor(mins)} min ago` : `${hours} hrs ago`;
        }

        async function deleteFeed(feedId) {
            if (!confirm('Delete this entry?')) return;

            try {
                const response = await fetch(`/api/feeds/${feedId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadFeeds(); // This also calls checkVitaminStatus()
                }
            } catch (error) {
                console.error('Error deleting feed:', error);
            }
        }

        // Voice recognition
        function startVoiceRecognition() {
            if (!recognition) return;

            voiceParsedData = null;
            document.getElementById('voiceTranscript').textContent = '';
            document.getElementById('voiceParsedSection').style.display = 'none';
            document.getElementById('voiceConfirm').style.display = 'none';

            recognition.start();

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }

                document.getElementById('voiceTranscript').textContent = transcript;

                // If final result, parse it
                if (event.results[event.results.length - 1].isFinal) {
                    parseVoiceInput(transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                document.getElementById('voiceTranscript').textContent = 'Error: ' + event.error;
            };

            recognition.onend = () => {
                document.getElementById('voiceListening').style.display = 'none';
            };
        }

        function parseVoiceInput(transcript) {
            const lower = transcript.toLowerCase();

            // Parse type
            let type = null;
            if (lower.includes('bottle') || lower.includes('fed') || lower.includes('feed')) {
                type = 'bottle';
            } else if (lower.includes('nurse') || lower.includes('nursed') || lower.includes('breastfed') || lower.includes('breast')) {
                type = 'nurse';
            } else if (lower.includes('pump') || lower.includes('pumped')) {
                type = 'pump';
            }

            // Parse side
            let side = null;
            if (lower.includes('left')) {
                side = 'left';
            } else if (lower.includes('right')) {
                side = 'right';
            } else if (lower.includes('both')) {
                side = 'both';
            }

            // Parse amount (look for number + "ml" or "milliliter")
            let amount = null;
            const amountMatch = lower.match(/(\d+(?:\.\d+)?)\s*(?:ml|milliliter)/);
            if (amountMatch) {
                amount = parseFloat(amountMatch[1]);
            } else {
                // Try number words (simplified for ml)
                const numberWords = {
                    'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
                    'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10
                };
                for (const [word, num] of Object.entries(numberWords)) {
                    if (lower.includes(word + ' ml') || lower.includes(word + ' milliliter')) {
                        amount = num;
                        break;
                    }
                }

                // Fallback: look for large numbers (>=5) without units
                if (!amount) {
                    const trailingNum = lower.match(/\b(\d+)\s*$/);
                    if (trailingNum) {
                        const val = parseInt(trailingNum[1]);
                        if (val >= 5) amount = val;
                    }
                }
            }

            // Parse duration (look for number + "minute" or "min")
            let duration = null;
            const durationMatch = lower.match(/(\d+)\s*(?:minute|min)/);
            if (durationMatch) {
                duration = parseInt(durationMatch[1]);
            }

            // Store parsed data
            voiceParsedData = { type, side, amount, duration };

            // Show parsed result
            const parsedHtml = `
                <div class="voice-parsed-item"><span class="voice-parsed-label">Type:</span> ${type || 'Not detected'}</div>
                ${side ? `<div class="voice-parsed-item"><span class="voice-parsed-label">Side:</span> ${side}</div>` : ''}
                ${amount ? `<div class="voice-parsed-item"><span class="voice-parsed-label">Amount:</span> ${amount} ml</div>` : ''}
                ${duration ? `<div class="voice-parsed-item"><span class="voice-parsed-label">Duration:</span> ${duration} min</div>` : ''}
            `;

            document.getElementById('voiceParsed').innerHTML = parsedHtml;
            document.getElementById('voiceParsedSection').style.display = 'block';
            document.getElementById('voiceConfirm').style.display = 'block';
        }

        document.getElementById('voiceConfirm').addEventListener('click', () => {
            if (voiceParsedData && voiceParsedData.type) {
                logFeed(voiceParsedData.type, voiceParsedData.side, voiceParsedData.amount);
            }
        });

        // Auto-refresh last feed time every 30 seconds
        setInterval(loadFeeds, 30000);

        // Live Clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            document.getElementById('liveClock').textContent = timeString;
        }
        setInterval(updateClock, 1000);
        updateClock(); // Initial call

        // Vitamin D status check and logging
        let vitaminLogging = false; // Prevent double-tap

        async function checkVitaminStatus() {
            try {
                const response = await fetch('/api/vitamin-status');
                const data = await response.json();
                const reminder = document.getElementById('vitaminReminder');

                if (data.given_today) {
                    // Already given ‚Äî hide banner
                    reminder.style.display = 'none';
                    reminder.classList.remove('confirming', 'sliding-out');
                } else {
                    // Not given ‚Äî show banner
                    reminder.style.display = 'flex';
                    reminder.classList.remove('confirming', 'sliding-out');
                    document.getElementById('vitaminCheck').style.opacity = '0';
                }
            } catch (error) {
                console.error('Error checking vitamin status:', error);
            }
        }

        async function logVitamin() {
            if (vitaminLogging) return; // Prevent double-tap
            vitaminLogging = true;

            const reminder = document.getElementById('vitaminReminder');

            try {
                const response = await fetch('/api/vitamin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ logged_by: currentWho })
                });

                const result = await response.json();

                if (result.success) {
                    lastCreatedFeedId = result.id;

                    // Phase 1: Confirmation animation
                    reminder.querySelector('.vitamin-text').textContent = 'Vitamin D given ‚úì';
                    reminder.classList.add('confirming');

                    // Phase 2: Slide out after 1.5s
                    setTimeout(() => {
                        reminder.classList.add('sliding-out');

                        // Phase 3: Hide after slide animation completes
                        setTimeout(() => {
                            reminder.style.display = 'none';
                            reminder.classList.remove('confirming', 'sliding-out');
                            reminder.querySelector('.vitamin-text').textContent = 'Tap to give Vitamin D drops';
                            vitaminLogging = false;
                        }, 500);
                    }, 1500);

                    // Show toast with undo
                    showToast('‚òÄÔ∏è Vitamin D given', true);

                    // Refresh feeds
                    loadFeeds();
                } else {
                    vitaminLogging = false;
                }
            } catch (error) {
                console.error('Error logging vitamin:', error);
                vitaminLogging = false;
            }
        }

        // ==========================================
        // CHARTS FUNCTIONALITY
        // ==========================================

        let currentChartRange = 7;
        let milkChartInstance = null;
        let diaperChartInstance = null;
        let timelineChartInstance = null;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.getElementById('trackerView').style.display = tab === 'tracker' ? '' : 'none';
                document.getElementById('chartsView').style.display = tab === 'charts' ? '' : 'none';

                if (tab === 'charts') {
                    loadChartData(currentChartRange);
                }
            });
        });

        // Range selector
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentChartRange = parseInt(btn.dataset.range);
                loadChartData(currentChartRange);
            });
        });

        // Load chart data from API
        async function loadChartData(days) {
            try {
                const response = await fetch(`/api/feeds?limit_days=${days}`);
                const data = await response.json();
                renderMilkChart(data.feeds, days);
                renderDiaperChart(data.feeds, days);
                renderTimelineChart(data.feeds, days);
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Aggregate milk by type
        function aggregateMilkByType(feeds, days) {
            const dates = [];
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                dates.push(`${year}-${month}-${day}`);
            }

            const breastMilk = {};
            const formula = {};
            dates.forEach(d => { breastMilk[d] = 0; formula[d] = 0; });

            feeds.forEach(feed => {
                if (feed.type.includes('Diaper') || feed.type.includes('Vitamin')) return;

                // Exclude Pump and Nurse - Only count Bottle feeds for intake
                if (feed.type.includes('Pump') || feed.type.includes('Nurse')) return;

                const typeLower = feed.type.toLowerCase();
                const amount = feed.amount_ml || 0;

                if (amount > 0 && amount <= 800) { // Sane limit?
                    if (dates.includes(feed.date)) {
                        if (typeLower.includes('formula')) {
                            formula[feed.date] += amount;
                        } else {
                            // "Milk" or "Breast Milk" or Unspecified all count as Breast Milk for now
                            // This includes pumped milk and unspecified bottles
                            breastMilk[feed.date] += amount;
                        }
                    }
                }
            });

            return {
                dates,
                breastMilk: dates.map(d => breastMilk[d]),
                formula: dates.map(d => formula[d])
            };
        }

        // Format date label for chart axis
        function formatChartLabel(dateStr) {
            const parts = dateStr.split('-');
            const d = new Date(parts[0], parts[1] - 1, parts[2]); // Local time construction
            const today = new Date();

            // Check if Today
            if (d.getDate() === today.getDate() &&
                d.getMonth() === today.getMonth() &&
                d.getFullYear() === today.getFullYear()) {
                return 'Today';
            }

            // Check if Yesterday
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            if (d.getDate() === yesterday.getDate() &&
                d.getMonth() === yesterday.getMonth() &&
                d.getFullYear() === yesterday.getFullYear()) {
                return 'Yest.';
            }

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return days[d.getDay()] + ' ' + d.getDate();
        }

        // Render Daily Milk Intake bar chart
        function renderMilkChart(feeds, days) {
            // Updated to Stacked Bar Chart for Formula vs Breast Milk
            const { dates, breastMilk, formula } = aggregateMilkByType(feeds, days);
            const labels = dates.map(formatChartLabel);

            // Unspecified feeds (backward compatibility) are grouped into Breast Milk for now, 
            // or we could add a third dataset. Let's assume most historical is breast milk.
            // If we want to be precise, we can check aggregateMilkByType implementation below.

            if (milkChartInstance) {
                milkChartInstance.destroy();
            }

            const ctx = document.getElementById('milkChart').getContext('2d');
            milkChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Breast Milk',
                            data: breastMilk,
                            backgroundColor: '#4A90D9', // Blue
                            borderRadius: 6,
                            borderSkipped: false,
                            maxBarThickness: 40,
                            stack: 'Stack 0'
                        },
                        {
                            label: 'Formula',
                            data: formula,
                            backgroundColor: '#FFB86C', // Orange/Peach
                            borderRadius: 6,
                            borderSkipped: false,
                            maxBarThickness: 40,
                            stack: 'Stack 0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#a8adb8', boxWidth: 12, padding: 10, font: { size: 11 } }
                        },
                        tooltip: {
                            backgroundColor: '#252b3b',
                            titleColor: '#e8eaed',
                            bodyColor: '#a8adb8',
                            borderColor: '#3d4556',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 10,
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' ml';
                                }
                            }
                        },
                        // Goal line annotation (using a simple plugin)
                        annotation: undefined
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                color: '#a8adb8',
                                font: { size: 11 },
                                maxRotation: 0
                            },
                            grid: { display: false },
                            border: { display: false }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            suggestedMax: 600,
                            ticks: {
                                color: '#a8adb8',
                                font: { size: 11 },
                                stepSize: 100,
                                callback: function (val) { return val + ' ml'; }
                            },
                            grid: {
                                color: '#2d3548',
                                drawBorder: false
                            },
                            border: { display: false }
                        }
                    },
                    layout: {
                        padding: { top: 10, bottom: 5 }
                    }
                },
                plugins: [{
                    // Custom plugin to draw the 500ml goal line
                    id: 'goalLine',
                    afterDraw: function (chart) {
                        const yScale = chart.scales.y;
                        const goalY = yScale.getPixelForValue(500);
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.beginPath();
                        ctx.setLineDash([6, 4]);
                        ctx.strokeStyle = '#F5A623';
                        ctx.lineWidth = 2;
                        ctx.moveTo(chart.chartArea.left, goalY);
                        ctx.lineTo(chart.chartArea.right, goalY);
                        ctx.stroke();

                        // Label
                        ctx.fillStyle = '#F5A623';
                        ctx.font = '11px -apple-system, sans-serif';
                        ctx.textAlign = 'right';
                        ctx.fillText('500ml goal', chart.chartArea.right, goalY - 6);
                        ctx.restore();
                    }
                }]
            });
        }

        // Aggregate Diapers by date
        function aggregateDiapersByDate(feeds, days) {
            const dates = [];
            const today = new Date();
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                dates.push(`${year}-${month}-${day}`);
            }

            // Initialize counters
            const data = {
                dates: dates,
                pee: dates.map(() => 0),
                poop: dates.map(() => 0),
                both: dates.map(() => 0)
            };

            feeds.forEach(feed => {
                if (!feed.type.includes('Diaper')) return;

                const dayIndex = dates.indexOf(feed.date);
                if (dayIndex === -1) return;

                // Check type field (e.g. "Diaper (Poop)", "Diaper (Pee)", "Diaper (Both)")
                const type = (feed.type || '').toLowerCase();

                if (type.includes('both')) {
                    data.both[dayIndex]++;
                } else if (type.includes('poop')) {
                    data.poop[dayIndex]++;
                } else {
                    // Default to pee if not specified, or if explicit 'pee'
                    // "Diaper" generic also counts as Pee
                    data.pee[dayIndex]++;
                }
            });

            return data;
        }

        // Render Diaper Stacked Bar Chart
        function renderDiaperChart(feeds, days) {
            const data = aggregateDiapersByDate(feeds, days);
            const labels = data.dates.map(formatChartLabel);

            if (diaperChartInstance) {
                diaperChartInstance.destroy();
            }

            const ctx = document.getElementById('diaperChart').getContext('2d');
            diaperChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Both',
                            data: data.both,
                            backgroundColor: '#5E4B8A', // Dark purple
                            borderRadius: 4
                        },
                        {
                            label: 'Poop',
                            data: data.poop,
                            backgroundColor: '#9C87E8', // Main purple
                            borderRadius: 4
                        },
                        {
                            label: 'Pee',
                            data: data.pee,
                            backgroundColor: '#D4C4FB', // Light purple
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                color: '#a8adb8',
                                font: { size: 11 },
                                maxRotation: 0
                            },
                            grid: { display: false },
                            border: { display: false }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#a8adb8',
                                font: { size: 11 }
                            },
                            grid: {
                                color: '#2d3548',
                                drawBorder: false
                            },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#a8adb8',
                                boxWidth: 12,
                                padding: 20,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#252b3b',
                            titleColor: '#e8eaed',
                            bodyColor: '#a8adb8',
                            borderColor: '#3d4556',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 10
                        }
                    },
                    layout: {
                        padding: { top: 10, bottom: 5 }
                    }
                }
            });
        }

        // Render Feed Timeline Chart (Scatter)
        function renderTimelineChart(feeds, days) {
            // 1. Prepare datasets
            const bottleData = [];
            const formulaData = []; // New formula dataset
            const nurseData = [];
            const pumpData = [];

            // 2. Filter key dates (for X axis categories)
            const dates = [];
            const today = new Date();
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                dates.push(`${year}-${month}-${day}`);
            }

            feeds.forEach(feed => {
                // Parse date/time
                if (!feed.timestamp) return;
                const dt = new Date(feed.timestamp);

                // Match feed.date to our X-axis categories
                if (!dates.includes(feed.date)) return; // Outside range

                // Y value: Decimal hours (0-24)
                const yVal = dt.getHours() + (dt.getMinutes() / 60);

                const point = { x: feed.date, y: yVal };

                if (feed.type.includes('Bottle')) {
                    if (feed.type.toLowerCase().includes('formula')) {
                        formulaData.push(point);
                    } else {
                        bottleData.push(point); // Milk/Breast Milk (Default)
                    }
                } else if (feed.type.includes('Nurse')) {
                    nurseData.push(point);
                } else if (feed.type.includes('Pump')) {
                    pumpData.push(point);
                }
            });

            if (timelineChartInstance) timelineChartInstance.destroy();

            const ctx = document.getElementById('timelineChart').getContext('2d');
            timelineChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    labels: dates, // X-axis categories
                    datasets: [
                        {
                            label: 'Breast Milk',
                            data: bottleData,
                            backgroundColor: '#4A90D9', // Blue
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Formula',
                            data: formulaData,
                            backgroundColor: '#FFB86C', // Orange/Peach
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Nurse',
                            data: nurseData,
                            backgroundColor: '#E8877C', // Pink
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Pump',
                            data: pumpData,
                            backgroundColor: '#5CB8B2', // Teal
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            offset: true,
                            ticks: {
                                color: '#a8adb8',
                                font: { size: 11 },
                                maxRotation: 0,
                                callback: function (val, index) {
                                    // val is index? or label? Chart.js category scale usually passes index or label depending on version.
                                    // but we can access `this.getLabelForValue(val)`
                                    const label = this.getLabelForValue(val);
                                    const d = new Date(label + 'T12:00:00'); // Safe parsing
                                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                                    return days[d.getDay()] + ' ' + d.getDate();
                                }
                            },
                            grid: {
                                color: '#2d3548',
                                drawBorder: false
                            }
                        },
                        y: {
                            min: 0,
                            max: 24,
                            reverse: true, // 12 AM at top (0), 11 PM at bottom (23)? Or normal? Timeline usually runs down? 
                            // Let's stick to normal graph behavior (0 bottom, 24 top) for now as requested in plan "12am - 11pm"
                            // Plan diagram showed 11pm at TOP.
                            // So reverse: false.
                            ticks: {
                                stepSize: 3,
                                color: '#a8adb8',
                                font: { size: 11 },
                                callback: function (val) {
                                    if (val === 0 || val === 24) return '12 AM';
                                    if (val === 12) return '12 PM';
                                    if (val < 12) return val + ' AM';
                                    return (val - 12) + ' PM';
                                }
                            },
                            grid: {
                                color: '#2d3548',
                                drawBorder: false
                            },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#a8adb8', boxWidth: 10, padding: 20, font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const val = context.parsed.y;
                                    const h = Math.floor(val);
                                    const m = Math.floor((val - h) * 60);
                                    const ampm = h >= 12 && h < 24 ? 'PM' : 'AM'; // Fix 24->AM
                                    const h12 = h % 12 || 12;
                                    const mStr = m.toString().padStart(2, '0');
                                    return `${context.dataset.label}: ${h12}:${mStr} ${ampm}`;
                                }
                            }
                        }
                    },
                    layout: { padding: { top: 10, bottom: 5 } }
                }
            });
        }

        // Initial load
        loadFeeds();
    </script>
</body>

</html>